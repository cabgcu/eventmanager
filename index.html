<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Arts Events Manager</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body { background: #f1f5f9; -webkit-tap-highlight-color: transparent; }
        .modal-bg { background: rgba(0,0,0,0.55); backdrop-filter: blur(4px); }
        .scroll-hide::-webkit-scrollbar { display: none; }
        tr { transition: background-color 0.2s ease; }
        
        /* Loading Spinner */
        .loader {
            border: 2px solid #e2e8f0;
            border-top: 2px solid #9333ea;
            border-radius: 50%;
            width: 14px;
            height: 14px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>

<body class="font-sans text-slate-800 p-4">

<!-- ====================================================== -->
<!-- APP CONTAINER -->
<!-- ====================================================== -->
<div id="app-container" class="max-w-[1400px] mx-auto">

    <!-- TOP BAR -->
    <div class="bg-white/80 backdrop-blur-md p-4 rounded-xl shadow-sm border border-slate-200 mb-6 flex flex-col md:flex-row justify-between gap-4 items-center">
        
        <div class="flex flex-col items-center md:items-start">
            <h1 class="text-2xl font-bold flex items-center gap-2 text-slate-900">
                üé® Arts Events Manager
            </h1>
            
            <!-- Sync Status Indicator (Read Only) -->
            <div class="text-xs font-medium text-slate-500 mt-1 flex items-center gap-2 px-1">
                <span id="sync-dot" class="w-2 h-2 rounded-full bg-slate-300"></span>
                <span id="sync-text">Connecting...</span>
            </div>
        </div>

        <div class="flex flex-wrap justify-center gap-3 items-center">
            
            <!-- Legend (Desktop) -->
            <div class="hidden lg:flex items-center gap-3 mr-2 text-xs font-medium bg-white/50 px-3 py-2 rounded-lg border border-slate-200">
                <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-red-500"></span> Overdue</span>
                <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-orange-400"></span> Due soon</span>
                <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-green-500"></span> Done</span>
            </div>

            <!-- Total Budget -->
            <div class="bg-green-50 px-4 py-2 rounded-lg border border-green-100 min-w-[100px] text-center md:text-left">
                <p class="text-[10px] text-green-600 font-bold uppercase tracking-wider">Total Budget</p>
                <p id="total-budget" class="text-lg font-bold text-green-700">$0</p>
            </div>

            <!-- Settings -->
            <button onclick="openSettings()" class="p-2.5 rounded-lg text-slate-500 hover:text-slate-700 hover:bg-slate-100 transition bg-white border border-slate-200">
                ‚öôÔ∏è
            </button>

            <!-- Add Event -->
            <button onclick="openEventEditor()" class="bg-purple-600 hover:bg-purple-700 text-white px-5 py-2.5 rounded-lg font-medium shadow-md transition transform active:scale-95 flex items-center gap-2">
                <span>+</span> New Event
            </button>
        </div>
    </div>

    <!-- EVENTS TABLE -->
    <div class="bg-white/90 backdrop-blur-sm rounded-xl shadow-sm border border-slate-200 overflow-hidden">
        <div class="overflow-x-auto scroll-hide">
            <table class="w-full text-sm text-left border-collapse">
                <thead class="bg-slate-900 text-slate-100 uppercase text-xs font-bold tracking-wider">
                    <tr id="table-header-row">
                        <!-- Headers injected via JS to ensure consistency -->
                    </tr>
                </thead>
                <tbody id="events-body" class="divide-y divide-slate-100">
                    <!-- Rows rendered via JS -->
                </tbody>
            </table>
        </div>
        
        <!-- Empty State -->
        <div id="empty-state" class="hidden flex-col items-center justify-center py-16 text-slate-400">
            <div class="text-4xl mb-2">üìÖ</div>
            <p>No events found. Create one to get started!</p>
        </div>
    </div>
</div>

<!-- ====================================================== -->
<!-- SETTINGS MODAL -->
<!-- ====================================================== -->
<div id="settings-modal" class="hidden fixed inset-0 modal-bg flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md max-h-[90vh] overflow-y-auto">
        <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50 rounded-t-2xl">
            <h2 class="text-lg font-bold text-slate-800">‚öôÔ∏è Settings</h2>
            <button class="text-slate-400 hover:text-slate-600 font-bold px-2" onclick="closeSettings()">‚úï</button>
        </div>
        <div class="p-6 space-y-6">
            <div>
                <h3 class="text-sm font-bold text-slate-700 mb-3 uppercase tracking-wider">Column Labels</h3>
                <div id="column-label-editor" class="space-y-3"></div>
            </div>

            <!-- Debugging Tool -->
            <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
                <h3 class="text-xs font-bold text-slate-500 uppercase mb-2">Troubleshooting</h3>
                <button onclick="manualForceSync()" class="w-full bg-white border border-slate-300 text-slate-700 py-2 rounded-lg text-sm font-medium hover:bg-slate-50 flex justify-center items-center gap-2">
                    üîÑ Force Cloud Sync Now
                </button>
                <p class="text-[10px] text-slate-400 mt-2 text-center">
                    If sync fails, ensure you deployed your Google Script as a <strong class="text-slate-600">"New Deployment"</strong>.
                </p>
            </div>
            
            <div class="pt-4 border-t border-slate-100">
                <button onclick="saveSettings()" class="w-full bg-slate-900 text-white py-3 rounded-xl hover:bg-slate-800 font-medium">
                    Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ====================================================== -->
<!-- EVENT MODAL -->
<!-- ====================================================== -->
<div id="event-modal" class="hidden fixed inset-0 modal-bg flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col">
        
        <!-- Modal Header -->
        <div class="p-5 border-b border-slate-100 bg-slate-50 flex justify-between items-start shrink-0">
            <div>
                <h2 id="event-modal-title" class="text-xl font-bold text-slate-800">Event Details</h2>
                <div class="flex gap-4 mt-3">
                    <button id="tab-details" onclick="switchTab('details')" class="text-sm font-medium pb-1 border-b-2 border-purple-600 text-purple-600 transition">Details</button>
                    <button id="tab-files" onclick="switchTab('files')" class="text-sm font-medium pb-1 text-slate-500 hover:text-slate-700 border-b-2 border-transparent transition">Files & Notes</button>
                </div>
            </div>
            <button onclick="closeEventModal()" class="text-slate-400 hover:text-slate-600 p-1">‚úï</button>
        </div>

        <!-- Modal Body -->
        <div id="event-modal-content" class="p-6 overflow-y-auto grow">
            <!-- Form content injected here -->
        </div>

        <!-- Modal Footer -->
        <div class="p-4 border-t border-slate-100 bg-white shrink-0">
            <button onclick="saveEvent()" class="w-full bg-purple-600 text-white py-3 rounded-xl hover:bg-purple-700 font-medium shadow-md transition transform active:scale-[0.99]">
                Save Event
            </button>
        </div>
    </div>
</div>

<script>
    // ==============================================================
    // 1. STATE & CONFIG
    // ==============================================================
    
    // ‚ö†Ô∏è UPDATED GOOGLE SCRIPT WEB APP URL
    const CLOUD_URL = "https://script.google.com/macros/s/AKfycbwssTzVBBEqi8vTtU2B8zBVQ3YFMtXJvyPvVUFwJv6a6Z5tcDK1WfYCYtZsVrLMtTdS/exec";

    // Load from LocalStorage immediately for fast paint
    let eventsData = JSON.parse(localStorage.getItem('arts_events_data') || '[]');
    let columnLabels = JSON.parse(localStorage.getItem('arts_column_labels') || JSON.stringify({
        marketing: "Marketing Req",
        amazon: "Amazon",
        setlist: "Setlist",
        chalkboards: "Chalkboards",
        posters: "Posters Up"
    }));
    
    let isSyncing = false;
    let syncInterval = null;

    const MILESTONE_KEYS = ["marketing", "amazon", "setlist", "chalkboards", "posters"];
    let editingEventId = null; 
    let tempFiles = {}; 

    // ==============================================================
    // 2. INIT
    // ==============================================================
    
    function initApp() {
        renderTableHeader();
        renderEvents();
        updateSyncUI();
        startCloudSync();
    }

    // ==============================================================
    // 3. CLOUD SYNC ENGINE (Google Sheets + Drive)
    // ==============================================================

    function startCloudSync() {
        updateSyncUI();
        if (syncInterval) clearInterval(syncInterval);
        
        // Initial Load
        loadFromCloud();
        
        // Poll every 15 seconds to check for updates from other users
        syncInterval = setInterval(loadFromCloud, 15000);
    }

    function updateSyncUI() {
        const dot = document.getElementById('sync-dot');
        const text = document.getElementById('sync-text');

        if (isSyncing) {
            dot.className = "loader border-slate-400 border-t-purple-600";
            text.innerText = "Syncing...";
            text.className = "text-slate-500";
        } else {
            dot.className = "w-2 h-2 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.5)]";
            text.innerText = "Live";
            text.className = "text-emerald-700 font-bold";
        }
    }
    
    // Debugging function for the user
    async function manualForceSync() {
        if (!confirm("Force data push to Google Sheets?")) return;
        const btn = document.querySelector('button[onclick="manualForceSync()"]');
        const oldText = btn.innerText;
        btn.innerText = "Pushing...";
        btn.disabled = true;
        
        await syncToCloud();
        
        setTimeout(() => {
            btn.innerText = oldText;
            btn.disabled = false;
            alert("Sync command sent. Check spreadsheet.");
        }, 1000);
    }

    // PUSH: Save local state to Sheets
    async function syncToCloud() {
        if (!CLOUD_URL) return;
        isSyncing = true;
        updateSyncUI();

        try {
            const payload = {
                action: 'save',
                events: eventsData
            };
            
            // Using text/plain + no-cors to prevent browser preflight blocks.
            await fetch(CLOUD_URL, {
                method: 'POST',
                mode: 'no-cors', 
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify(payload)
            });
            console.log("Sent save request to cloud");
        } catch (e) {
            console.error("Sync Error", e);
            document.getElementById('sync-text').innerText = "Sync Error";
            document.getElementById('sync-dot').className = "w-2 h-2 rounded-full bg-red-500";
        } finally {
            setTimeout(() => {
                isSyncing = false;
                updateSyncUI();
            }, 1000);
        }
    }

    // UPLOAD: Send file to Drive via Apps Script
    async function uploadToDrive(file, uiCallback) {
        if (!CLOUD_URL) return null;
        
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            
            // Error handling for read
            reader.onerror = () => {
                uiCallback('Error');
                alert("Failed to read file.");
                resolve(null);
            };

            reader.onload = async () => {
                try {
                    // Remove "data:*/*;base64," prefix
                    const base64 = reader.result.split(',')[1];
                    
                    const payload = {
                        action: 'upload',
                        fileName: file.name,
                        mimeType: file.type,
                        fileData: base64
                    };

                    uiCallback('Uploading...');
                    
                    // We need to read the response, so we use standard POST with text/plain
                    const res = await fetch(CLOUD_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify(payload)
                    });
                    
                    const json = await res.json();
                    
                    if (json.success) {
                        uiCallback('Done');
                        resolve(json.url);
                    } else {
                        uiCallback('Failed');
                        console.error("Upload failed server-side:", json);
                        alert("Google Drive Upload Failed: " + (json.error || "Unknown Error"));
                        resolve(null);
                    }
                } catch (e) {
                    uiCallback('Error');
                    console.error("Upload failed network:", e);
                    alert("Network Error during upload. Check internet or file size.");
                    resolve(null);
                }
            };

            reader.readAsDataURL(file);
        });
    }

    // PULL: Get state from Sheets
    async function loadFromCloud() {
        if (!CLOUD_URL || isSyncing) return;
        try {
            const res = await fetch(CLOUD_URL);
            const data = await res.json();
            
            if (data.events && Array.isArray(data.events)) {
                const currentStr = JSON.stringify(eventsData);
                const newStr = JSON.stringify(data.events);

                if (currentStr !== newStr) {
                    console.log("New data found, updating...");
                    eventsData = data.events;
                    saveLocal(false);
                    renderEvents(); 
                }
            }
        } catch (e) {
            console.error("Load Error", e);
        }
    }

    function saveLocal(triggerSync = true) {
        localStorage.setItem('arts_events_data', JSON.stringify(eventsData));
        localStorage.setItem('arts_column_labels', JSON.stringify(columnLabels));
        updateTotalBudget();
        if (triggerSync) syncToCloud();
    }

    // ==============================================================
    // 4. DATA OPERATIONS
    // ==============================================================

    function saveEvent() {
        const name = document.getElementById('form-name').value;
        if (!name) return alert("Event Name is required");

        const newEvent = {
            id: editingEventId || 'ev_' + Date.now().toString(36),
            name: name,
            date: document.getElementById('form-date').value,
            time: document.getElementById('form-time').value,
            location: document.getElementById('form-location').value,
            budget: Number(document.getElementById('form-budget').value) || 0,
            cart: document.getElementById('form-cart').value,
            contact: document.getElementById('form-contact').value,
            status: document.getElementById('form-status').value,
            deadlines: {},
            files: tempFiles
        };

        // Collect deadlines
        MILESTONE_KEYS.forEach(key => {
            newEvent.deadlines[key] = {
                date: document.getElementById(`deadline-${key}`).value,
                assignee: document.getElementById(`assign-${key}`).value,
                completed: document.getElementById(`completed-${key}`) ? document.getElementById(`completed-${key}`).checked : false
            };
        });

        if (editingEventId) {
            const index = eventsData.findIndex(e => e.id === editingEventId);
            if (index !== -1) eventsData[index] = newEvent;
        } else {
            eventsData.push(newEvent);
        }

        saveLocal();
        renderEvents();
        closeEventModal();
    }

    function updateStatus(id, newStatus) {
        const ev = eventsData.find(e => e.id === id);
        if (ev) {
            ev.status = newStatus;
            saveLocal();
        }
    }

    function deleteEvent(id) {
        if(confirm("Are you sure you want to delete this event?")) {
            eventsData = eventsData.filter(e => e.id !== id);
            saveLocal();
            renderEvents();
        }
    }

    function toggleDeadline(eventId, key) {
        const ev = eventsData.find(e => e.id === eventId);
        if (ev) {
            if (!ev.deadlines) ev.deadlines = {};
            if (!ev.deadlines[key]) ev.deadlines[key] = {};
            ev.deadlines[key].completed = !ev.deadlines[key].completed;
            saveLocal();
            renderEvents();
        }
    }

    // ==============================================================
    // 5. RENDERING LOGIC
    // ==============================================================

    function renderTableHeader() {
        const row = document.getElementById('table-header-row');
        row.innerHTML = `
            <th class="px-4 py-3 min-w-[180px] sticky left-0 bg-slate-900 z-10 shadow-[2px_0_5px_rgba(0,0,0,0.1)]">Event Name</th>
            <th class="px-4 py-3 min-w-[90px]">Date</th>
            <th class="px-4 py-3 min-w-[90px]">Time</th>
            <th class="px-4 py-3 min-w-[100px]">Location</th>
            <th class="px-4 py-3 min-w-[90px]">Budget</th>
            <!-- DYNAMIC HERE -->
            <th class="px-4 py-3 min-w-[90px]">Cart</th>
            <th class="px-4 py-3 min-w-[100px]">Status</th>
            <th class="px-4 py-3 w-[60px]"></th>
        `;

        const refNode = row.children[5]; // The "Cart" column
        
        MILESTONE_KEYS.forEach(key => {
            const th = document.createElement('th');
            th.className = "px-4 py-3 min-w-[130px] bg-slate-900 text-center uppercase tracking-wider text-slate-100 font-bold";
            th.textContent = columnLabels[key] || key;
            row.insertBefore(th, refNode);
        });
    }

    function renderEvents() {
        const tbody = document.getElementById('events-body');
        tbody.innerHTML = '';

        if (eventsData.length === 0) {
            document.getElementById('empty-state').classList.remove('hidden');
            document.getElementById('empty-state').classList.add('flex');
        } else {
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('empty-state').classList.remove('flex');
        }

        const sorted = [...eventsData].sort((a,b) => {
            if(!a.date) return 1;
            if(!b.date) return -1;
            return new Date(a.date) - new Date(b.date);
        });

        sorted.forEach(ev => {
            const tr = document.createElement('tr');
            tr.className = "hover:bg-slate-50 group border-b border-slate-50 last:border-0";
            
            // Base Columns
            let html = `
                <td class="px-4 py-3 font-semibold text-slate-900 sticky left-0 bg-white group-hover:bg-slate-50 border-r border-slate-100 shadow-[2px_0_5px_rgba(0,0,0,0.05)] z-10">
                    <div class="flex items-center gap-2">
                        ${ev.name}
                        ${hasFiles(ev) ? '<span class="text-[10px] text-slate-400" title="Has attachments">üìé</span>' : ''}
                    </div>
                </td>
                <td class="px-4 py-3 text-slate-600 text-xs">${formatDate(ev.date)}</td>
                <td class="px-4 py-3 text-slate-600 text-xs">${ev.time || '-'}</td>
                <td class="px-4 py-3 text-slate-600 text-xs truncate max-w-[120px]">${ev.location || '-'}</td>
                <td class="px-4 py-3 text-slate-600 font-mono text-xs">$${(ev.budget || 0).toLocaleString()}</td>
            `;

            // Milestone Columns
            MILESTONE_KEYS.forEach(key => {
                const m = ev.deadlines?.[key] || {};
                const status = getDeadlineStatus(m.date, m.completed);
                const colorClass = getStatusClasses(status);
                
                html += `
                    <td class="px-2 py-3 border-l border-slate-100 text-center align-top bg-opacity-50 ${status === 'overdue' ? 'bg-red-50/30' : ''}">
                        ${m.date ? `
                            <div class="flex flex-col gap-1 items-center">
                                <button onclick="toggleDeadline('${ev.id}', '${key}')" 
                                    class="w-full py-1 px-1 rounded text-[10px] font-bold border transition-all shadow-sm active:scale-95 ${colorClass}">
                                    ${m.completed ? 'COMPLETED' : formatDate(m.date)}
                                </button>
                                ${m.assignee ? `<span class="text-[9px] text-slate-400 font-medium truncate max-w-[80px]">${m.assignee}</span>` : ''}
                            </div>
                        ` : '<span class="text-slate-200 text-xl">-</span>'}
                    </td>
                `;
            });

            // End Columns
            html += `
                <td class="px-4 py-3 border-l border-slate-100">
                    <span class="inline-block bg-yellow-100 text-yellow-800 text-[10px] px-2 py-1 rounded-full font-medium whitespace-nowrap">
                        ${ev.cart || '-'}
                    </span>
                </td>
                <td class="px-4 py-3">
                    <select onchange="updateStatus('${ev.id}', this.value)" 
                        class="text-[10px] font-bold px-2 py-1 rounded border-none focus:ring-2 focus:ring-purple-200 cursor-pointer outline-none 
                        ${ev.status === 'Approved' ? 'bg-green-100 text-green-700' : 
                          ev.status === 'Denied' ? 'bg-red-100 text-red-700' : 
                          ev.status === 'Submit' ? 'bg-blue-100 text-blue-700' : 'bg-slate-100 text-slate-600'}">
                        <option value="Submit" ${ev.status === 'Submit' ? 'selected' : ''}>Submit</option>
                        <option value="Pending" ${ev.status === 'Pending' ? 'selected' : ''}>Pending</option>
                        <option value="Approved" ${ev.status === 'Approved' ? 'selected' : ''}>Approved</option>
                        <option value="Denied" ${ev.status === 'Denied' ? 'selected' : ''}>Denied</option>
                    </select>
                </td>
                <td class="px-4 py-3 text-right">
                    <div class="flex gap-2 justify-end">
                        <button onclick="editEvent('${ev.id}')" class="text-slate-400 hover:text-blue-500 transition">‚úé</button>
                        <button onclick="deleteEvent('${ev.id}')" class="text-slate-400 hover:text-red-500 transition">‚úï</button>
                    </div>
                </td>
            `;
            
            tr.innerHTML = html;
            tbody.appendChild(tr);
        });
        
        updateTotalBudget();
    }

    function updateTotalBudget() {
        const total = eventsData.reduce((sum, ev) => sum + (ev.budget || 0), 0);
        document.getElementById('total-budget').textContent = '$' + total.toLocaleString();
    }

    // ==============================================================
    // 6. HELPER FUNCTIONS
    // ==============================================================

    function formatDate(dateStr) {
        if (!dateStr) return '';
        const d = new Date(dateStr);
        // Correct for timezone offset to prevent one-day-off errors
        const userTimezoneOffset = d.getTimezoneOffset() * 60000;
        const adjustedDate = new Date(d.getTime() + userTimezoneOffset);
        return `${adjustedDate.getMonth() + 1}/${adjustedDate.getDate()}`;
    }

    function getDeadlineStatus(dateStr, isCompleted) {
        if (!dateStr) return 'none';
        if (isCompleted) return 'completed';
        
        const today = new Date();
        today.setHours(0,0,0,0);
        const due = new Date(dateStr);
        const dueAdjusted = new Date(due.getTime() + (due.getTimezoneOffset() * 60000));
        
        const diffDays = Math.ceil((dueAdjusted - today) / (1000 * 60 * 60 * 24));
        
        if (diffDays < 0) return 'overdue';
        if (diffDays <= 7) return 'warning';
        return 'safe';
    }

    function getStatusClasses(status) {
        switch(status) {
            case 'completed': return 'bg-green-100 text-green-700 border-green-200 hover:bg-green-200';
            case 'overdue': return 'bg-red-500 text-white border-red-600 animate-pulse hover:bg-red-600';
            case 'warning': return 'bg-orange-100 text-orange-700 border-orange-200 hover:bg-orange-200';
            default: return 'bg-white text-slate-600 border-slate-200 hover:bg-slate-50';
        }
    }

    function hasFiles(ev) {
        if (!ev.files) return false;
        return Object.values(ev.files).some(arr => arr && arr.length > 0);
    }

    // ==============================================================
    // 7. MODAL & FORM LOGIC
    // ==============================================================

    function openEventEditor(id = null) {
        editingEventId = id;
        const modal = document.getElementById('event-modal');
        const content = document.getElementById('event-modal-content');
        const title = document.getElementById('event-modal-title');
        
        modal.classList.remove('hidden');

        let data = {};
        if (id) {
            data = eventsData.find(e => e.id === id);
            title.textContent = "Edit Event";
        } else {
            // Default Data
            data = {
                name: '', date: '', time: '', location: '', budget: '', cart: 'Caddy', contact: '', status: 'Submit', deadlines: {}, files: { general: [], marketing: [], amazon: [] }
            };
            title.textContent = "New Event";
        }

        tempFiles = JSON.parse(JSON.stringify(data.files || { general: [], marketing: [], amazon: [] }));

        // Generate Form HTML
        content.innerHTML = `
            <div id="form-tab-details" class="space-y-6">
                <!-- Core Info -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="md:col-span-2">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Event Name</label>
                        <input id="form-name" value="${data.name}" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-200 outline-none" placeholder="e.g. Spring Concert">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Date</label>
                        <input id="form-date" type="date" value="${data.date}" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-200 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Time</label>
                        <input id="form-time" value="${data.time}" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-200 outline-none" placeholder="e.g. 6pm - 8pm">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Location</label>
                        <input id="form-location" value="${data.location}" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-200 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Budget ($)</label>
                        <input id="form-budget" type="number" value="${data.budget}" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-200 outline-none">
                    </div>
                </div>

                <!-- Logistics -->
                <div class="grid grid-cols-3 gap-4 bg-slate-50 p-4 rounded-xl border border-slate-100">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Cart</label>
                        <select id="form-cart" class="w-full px-3 py-2 border border-slate-300 rounded-lg bg-white">
                            <option ${data.cart==='Caddy'?'selected':''}>Caddy</option>
                            <option ${data.cart==='Golf Cart'?'selected':''}>Golf Cart</option>
                            <option ${data.cart==='Truck'?'selected':''}>Truck</option>
                            <option ${data.cart==='None'?'selected':''}>None</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Contact</label>
                        <input id="form-contact" value="${data.contact}" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Status</label>
                        <select id="form-status" class="w-full px-3 py-2 border border-slate-300 rounded-lg bg-white">
                            <option ${data.status==='Submit'?'selected':''}>Submit</option>
                            <option ${data.status==='Pending'?'selected':''}>Pending</option>
                            <option ${data.status==='Approved'?'selected':''}>Approved</option>
                            <option ${data.status==='Denied'?'selected':''}>Denied</option>
                        </select>
                    </div>
                </div>

                <!-- Deadlines Section -->
                <div class="border-t pt-4">
                    <h3 class="text-sm font-bold text-slate-700 mb-3 uppercase tracking-wider">Deadlines</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                        ${MILESTONE_KEYS.map(key => {
                            const m = data.deadlines?.[key] || {date:'', assignee:'', completed:false};
                            return `
                                <div class="bg-white border border-slate-200 rounded-lg p-3 shadow-sm">
                                    <div class="flex justify-between items-center mb-2">
                                        <label class="text-xs font-bold text-purple-700">${columnLabels[key] || key}</label>
                                        <input type="checkbox" id="completed-${key}" ${m.completed ? 'checked' : ''} class="accent-green-500 w-4 h-4">
                                    </div>
                                    <input id="deadline-${key}" type="date" value="${m.date}" class="w-full mb-2 text-xs border rounded p-1 bg-slate-50">
                                    <input id="assign-${key}" value="${m.assignee}" placeholder="Assignee..." class="w-full text-xs border rounded p-1">
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            </div>

            <!-- Files Tab -->
            <div id="form-tab-files" class="hidden space-y-4">
                <div class="p-4 bg-blue-50 text-blue-800 text-xs rounded-lg mb-4 flex items-start gap-2">
                    <span class="text-lg">‚ÑπÔ∏è</span>
                    <p>Files are uploaded securely to your Google Drive "Arts Manager Files" folder.</p>
                    <p class="mt-1 text-slate-500 font-semibold">Note: File size limit is 25MB.</p>
                </div>
                ${renderFileCategories()}
            </div>
        `;

        attachFileHandlers();
        
        // MOVED HERE: Switch to details tab AFTER content is injected
        switchTab('details');
    }

    function editEvent(id) {
        openEventEditor(id);
    }

    function closeEventModal() {
        document.getElementById('event-modal').classList.add('hidden');
    }

    function switchTab(tab) {
        const detailsTab = document.getElementById('form-tab-details');
        const filesTab = document.getElementById('form-tab-files');
        const btnDetails = document.getElementById('tab-details');
        const btnFiles = document.getElementById('tab-files');
        
        // Safety check to prevent crash if called too early
        if (!detailsTab || !filesTab) return;

        if (tab === 'details') {
            detailsTab.classList.remove('hidden');
            filesTab.classList.add('hidden');
            btnDetails.classList.add('border-purple-600', 'text-purple-600');
            btnDetails.classList.remove('border-transparent');
            btnFiles.classList.remove('border-purple-600', 'text-purple-600');
            btnFiles.classList.add('border-transparent');
        } else {
            detailsTab.classList.add('hidden');
            filesTab.classList.remove('hidden');
            btnFiles.classList.add('border-purple-600', 'text-purple-600');
            btnFiles.classList.remove('border-transparent');
            btnDetails.classList.remove('border-purple-600', 'text-purple-600');
            btnDetails.classList.add('border-transparent');
        }
    }

    // ==============================================================
    // 8. FILES LOGIC
    // ==============================================================

    function renderFileCategories() {
        const categories = [
            { id: "general", label: "Event Checklist & General" },
            { id: "marketing", label: "Marketing Requests" },
            { id: "amazon", label: "Amazon Orders" }
        ];

        return categories.map(cat => `
            <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-semibold text-sm text-slate-700">${cat.label}</h3>
                    <label class="cursor-pointer bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 px-3 py-1.5 rounded-lg text-xs font-medium shadow-sm transition">
                        Upload File
                        <input type="file" class="hidden file-input" data-cat="${cat.id}">
                    </label>
                </div>
                <div id="file-list-${cat.id}" class="space-y-2">
                    ${(tempFiles[cat.id] && tempFiles[cat.id].length > 0) ? 
                        tempFiles[cat.id].map(f => `
                            <div class="bg-white p-2.5 rounded-lg border border-slate-200 flex justify-between items-center shadow-sm">
                                <div class="flex items-center gap-2 overflow-hidden">
                                    <span class="text-lg">üìÑ</span>
                                    <div class="min-w-0">
                                        <div class="text-xs font-bold text-slate-800 truncate">
                                            ${f.url ? `<a href="${f.url}" target="_blank" class="text-blue-600 hover:underline">${f.name}</a>` : f.name}
                                        </div>
                                        <div class="text-[10px] text-slate-400">${f.size || 'Drive File'} ‚Ä¢ ${f.date}</div>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    ${f.status === 'uploading' ? '<span class="text-[10px] text-purple-600 font-bold animate-pulse">Uploading...</span>' : ''}
                                    <button onclick="removeFile('${cat.id}', '${f.id}')" class="text-red-400 hover:text-red-600 p-1">‚úï</button>
                                </div>
                            </div>
                        `).join('') 
                    : '<div class="text-center py-4 border-2 border-dashed border-slate-200 rounded-lg text-xs text-slate-400">No files uploaded yet</div>'}
                </div>
            </div>
        `).join('');
    }

    function attachFileHandlers() {
        document.querySelectorAll('.file-input').forEach(input => {
            input.addEventListener('change', async (e) => {
                const cat = e.target.dataset.cat;
                const file = e.target.files[0];
                if (!file) return;

                // 1. SIZE CHECK (Crucial to prevent crashes)
                if (file.size > 25 * 1024 * 1024) {
                    alert("File too large. Please select a file under 25MB.");
                    e.target.value = ""; // Reset input
                    return;
                }

                // Create a temporary ID and visual state
                const tempId = 'f_' + Math.random().toString(36).substr(2, 9);
                
                const newFile = {
                    id: tempId,
                    name: file.name,
                    size: (file.size / 1024).toFixed(1) + ' KB',
                    date: new Date().toLocaleDateString(),
                    type: file.type,
                    status: 'uploading',
                    url: null
                };

                if (!tempFiles[cat]) tempFiles[cat] = [];
                tempFiles[cat].push(newFile);
                
                // Refresh UI to show "Uploading..."
                document.getElementById('form-tab-files').innerHTML = `
                    <div class="p-4 bg-blue-50 text-blue-800 text-xs rounded-lg mb-4 flex items-start gap-2">
                        <span class="text-lg">‚ÑπÔ∏è</span>
                        <p>Files are uploaded securely to your Google Drive "Arts Manager Files" folder.</p>
                        <p class="mt-1 text-slate-500 font-semibold">Note: File size limit is 25MB.</p>
                    </div>
                    ${renderFileCategories()}
                `;
                
                // PERFORM THE UPLOAD
                const driveUrl = await uploadToDrive(file, (status) => {
                   // Optional progress callback
                });
                
                // Update state with URL
                const targetFile = tempFiles[cat].find(f => f.id === tempId);
                if (targetFile) {
                    if (driveUrl) {
                        targetFile.url = driveUrl;
                        targetFile.status = 'done';
                    } else {
                        targetFile.name += " (Upload Failed)";
                        targetFile.status = 'error';
                        // Optionally remove from list or keep to show error
                    }
                }
                
                // Re-render final state
                document.getElementById('form-tab-files').innerHTML = `
                    <div class="p-4 bg-blue-50 text-blue-800 text-xs rounded-lg mb-4 flex items-start gap-2">
                        <span class="text-lg">‚ÑπÔ∏è</span>
                        <p>Files are uploaded securely to your Google Drive "Arts Manager Files" folder.</p>
                        <p class="mt-1 text-slate-500 font-semibold">Note: File size limit is 25MB.</p>
                    </div>
                    ${renderFileCategories()}
                `;
                attachFileHandlers(); // Re-attach listener
            });
        });
    }

    window.removeFile = function(cat, fileId) {
        tempFiles[cat] = tempFiles[cat].filter(f => f.id !== fileId);
        document.getElementById('form-tab-files').innerHTML = `
            <div class="p-4 bg-blue-50 text-blue-800 text-xs rounded-lg mb-4 flex items-start gap-2">
                <span class="text-lg">‚ÑπÔ∏è</span>
                <p>Files are uploaded securely to your Google Drive "Arts Manager Files" folder.</p>
                <p class="mt-1 text-slate-500 font-semibold">Note: File size limit is 25MB.</p>
            </div>
            ${renderFileCategories()}
        `;
        attachFileHandlers();
    };

    // ==============================================================
    // 9. SETTINGS LOGIC
    // ==============================================================

    function openSettings() {
        const modal = document.getElementById('settings-modal');
        const editor = document.getElementById('column-label-editor');
        modal.classList.remove('hidden');

        editor.innerHTML = MILESTONE_KEYS.map(key => `
            <div class="flex items-center gap-2">
                <span class="text-xs font-mono w-24 text-right text-slate-500">${key}</span>
                <input id="setting-col-${key}" value="${columnLabels[key]}" class="flex-1 px-3 py-2 border rounded-lg text-sm bg-slate-50 focus:bg-white focus:ring-2 focus:ring-purple-200 outline-none">
            </div>
        `).join('');
    }

    function closeSettings() {
        document.getElementById('settings-modal').classList.add('hidden');
    }

    function saveSettings() {
        const newLabels = { ...columnLabels };
        MILESTONE_KEYS.forEach(key => {
            newLabels[key] = document.getElementById(`setting-col-${key}`).value;
        });

        columnLabels = newLabels;
        saveLocal();
        renderTableHeader();
        renderEvents();
        closeSettings();
    }

    // ==============================================================
    // 10. BOOT
    // ==============================================================
    
    initApp();

</script>

</body>
</html>
